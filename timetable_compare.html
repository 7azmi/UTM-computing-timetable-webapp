<!DOCTYPE html>
<html>
<head>
    <title>UTM Tempo - Compare Timetables</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-teal.css">
    <style>
        .clash {
            background-color: red;
            color: white;
        }
        .user-label {
            font-weight: bold;
            margin-right: 10px;
        }
        .result-item {
            cursor: pointer;
            padding: 5px;
        }
        .result-item:hover {
            background-color: #ddd;
        }
        .search-container {
            position: relative;
        }
        .search-results {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            width: 100%;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="w3-theme-l5" style="max-width:600px">
    <div class="w3-container w3-theme">
        <h2>Compare Timetables</h2>
        <div style="margin-bottom: 20px;">
            <div class="search-container">
                <label class="user-label" for="firstUserInput">User 1:</label>
                <input type="text" id="firstUserInput" class="w3-input w3-border" style="width: auto; display: inline-block; margin-right: 10px;">
            </div>
            <br>
            <div class="search-container">
                <label class="user-label" for="secondUserInput">User 2:</label>
                <input type="text" id="secondUserInput" class="w3-input w3-border" style="width: auto; display: inline-block; margin-right: 10px;">
                <button onclick="searchSecondUser()" class="w3-button w3-blue">Search</button>
                <div id="searchResults" class="search-results w3-container w3-light-grey"></div>
            </div>
        </div>
    </div>
    <div id="timetable-container"></div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="SubjectManager.js"></script>
<script src="TTMS_Lib.js"></script>
<script>
    let allUsers = [];
    let firstUserTimetable = {};
    let secondUserTimetable = {};
    let firstUserName = "";
    let secondUserName = "";

    $(document).ready(function() {
        if (checkSession()) {
            initializeTimetable();
            cacheAllUsers();
        }
        $('#secondUserInput').on('input', filterSearchResults);
    });

    async function initializeTimetable() {
        const appStorage = JSON.parse(sessionStorage.getItem("web_fc_utm_my_ttms"));
        const subjectManager = new SubjectManager();
        const user_id = appStorage.user_auth.description === "Pensyarah" ? appStorage.user_auth.no_pekerja : appStorage.user_auth.login_name;
        $('#firstUserInput').val(user_id);
        await fetchAndDisplayTimetable(user_id, 'firstUser');
    }

    async function cacheAllUsers() {
        const subjectManager = new SubjectManager();
        const appStorage = JSON.parse(sessionStorage.getItem("web_fc_utm_my_ttms"));
        const userSessionId = appStorage.user_auth.session_id;
        const adminSessionId = await subjectManager.fetchAdminSessionId(userSessionId);
        const sesi = "2023/2024"; // Replace with the current session
        const semester = 2; // Replace with the current semester

        const [students, lecturers] = await Promise.all([
            subjectManager.fetchAllStudents(adminSessionId, sesi, semester),
            subjectManager.fetchAllLecturers(adminSessionId, sesi, semester)
        ]);

        allUsers = [...students, ...lecturers];
    }

    async function fetchAndDisplayTimetable(userId, userType) {
        const subjectManager = new SubjectManager();
        let latestSemesterSubjects = [];

        if (isLecturerId(userId)) {
            latestSemesterSubjects = await subjectManager.fetchLatestSemesterLecturerSubjects(userId);
        } else {
            latestSemesterSubjects = await subjectManager.fetchLatestSemesterStudentSubjects(userId);
        }

        let timetable = {};
        for (const subject of latestSemesterSubjects) {
            const timetableEntries = await subjectManager.fetchSubjectTimetable(subject.kod_subjek, subject.sesi, subject.semester, subject.seksyen);
            timetableEntries.forEach(entry => {
                const key = `${entry.hari}-${entry.masa}`;
                timetable[key] = `${subject.nama_subjek} | ${entry.ruang.nama_ruang_singkatan} | ${subject.kod_subjek}-${subject.seksyen}`;
            });
        }

        if (userType === 'firstUser') {
            firstUserTimetable = timetable;
            firstUserName = userId;
        } else {
            secondUserTimetable = timetable;
            secondUserName = userId;
        }

        displayTimetables();
    }

    function displayTimetables() {
        let timetableHtml = '<table class="w3-table-all w3-centered w3-card">';
        timetableHtml += '<tr class="w3-theme-d2"><th>Time / Day</th><th>Sunday</th><th>Monday</th><th>Tuesday</th><th>Wednesday</th><th>Thursday</th></tr>';

        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday'];
        const timeSlots = { 2: '8 AM', 3: '9 AM', 4: '10 AM', 5: '11 AM', 6: '12 PM', 7: 'Lunch break', 8: '2 PM', 9: '3 PM', 10: '4 PM', 11: '5 PM' };

        Object.keys(timeSlots).forEach(hour => {
            timetableHtml += `<tr><td>${timeSlots[hour]}</td>`;
            days.forEach((_, index) => {
                const key = `${index + 1}-${hour}`;
                const firstUserData = firstUserTimetable[key] || '';
                const secondUserData = secondUserTimetable[key] || '';
                const clashClass = firstUserData && secondUserData ? 'clash' : '';
                timetableHtml += `<td id="cell-${key}" class="${clashClass}">${firstUserData}<br>${secondUserData}</td>`;
            });
            timetableHtml += '</tr>';
        });
        timetableHtml += '</table>';

        $('#timetable-container').html(`
            <div class="w3-container w3-margin-bottom">
                <h3>User 1: ${firstUserName}</h3>
                <h3>User 2: ${secondUserName}</h3>
            </div>
            ${timetableHtml}
        `);
    }

    function filterSearchResults() {
        const searchTerm = $('#secondUserInput').val().toLowerCase();
        const results = allUsers.filter(user => {
            const userName = `${user.first_name} ${user.last_name}`.toLowerCase();
            return userName.includes(searchTerm);
        });

        displaySearchResults(results);
    }

    function displaySearchResults(results) {
        let resultsHtml = '<ul class="w3-ul">';
        results.forEach(user => {
            const userId = user.description === "Pensyarah" ? user.no_pekerja : user.no_matrik;
            const userType = user.description === "Pensyarah" ? "Lecturer" : "Student";
            resultsHtml += `<li class="result-item" onclick="selectUser('${userId}')">${user.first_name} ${user.last_name} (${userType})</li>`;
        });
        resultsHtml += '</ul>';

        $('#searchResults').html(resultsHtml).show();
    }

    function selectUser(userId) {
        $('#secondUserInput').val(userId);
        $('#searchResults').hide();
        fetchAndDisplayTimetable(userId, 'secondUser');
    }

    function checkSession() {
        if (!sessionStorage.getItem("web_fc_utm_my_ttms")) {
            window.location.href = "login.html";
            return false;
        }
        return true;
    }

    function isLecturerId(id) {
        return /^\d+$/.test(id);
    }
</script>
</html>
